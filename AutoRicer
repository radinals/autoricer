#!/usr/bin/env bash

error(){ printf "%s\n" "##### $1 #####" >&2; exit 1; }

GitCloneRepo(){
    if [ ! -d "$1" ]; then
	printf "%s\n" "Git cloning repository..." && \
	    git clone "$2" "$1" && printf "%s\n" "Repo Cloned..."
    else
	printf "%s\n" "Checking for updates..."
	cd "$1" || exit 1
	git pull
    fi
    printf "\n" 
}

MakePkg(){
    cd "$1" || exit 1
    printf "%s\n" "Building..."
    make
    make install
    printf "%s\n" "Build complete..."
    printf "\n" 
}

MakeNvim(){
    cd "$1" || exit 1
    printf "%s\n" "Building neovim stable..."
    git checkout stable
    make CMAKE_BUILD_TYPE=Release 
    make install
    printf "%s\n" "Build complete..."
    printf "\n" 
}

GitMakeInstall(){
    ProgRepo="$1"
    SourceDir="/usr/local/src"
    ProgName=$(basename "$ProgRepo" .git)

    [ -z "$ProgName" ] && error "Missing the program name!."
    [ -z "$ProgRepo" ] && error "Missing the program repository link!."

    [ ! -d "$SourceDir" ] && mkdir -p "$SourceDir"

    printf "%s\n" "##### $ProgName #####"

    if [ "$ProgName" == "neovim" ]; then
        read -p "install neovim stable? Y/N" confirm_neovim
        if [ "${confirm_neovim^^}" == "Y" ]; then
            GitCloneRepo "$SourceDir/$ProgName" "$ProgRepo" || error "An error occured when git cloning neovim"
            MakeNvim "$SourceDir/$ProgName" || error "An error occured when building neovim"
        else
            printf "%s\n" "cancelled..."
        fi
    else
        GitCloneRepo "$SourceDir/$ProgName" "$ProgRepo" || error "An error occured when cloning $ProgName"
        MakePkg "$SourceDir/$ProgName" || error "An error occured when building $ProgName"
    fi
}

GitRepoList=("https://github.com/radinals/dwm.git"
    "https://github.com/radinals/dwmblocks.git"
    "https://github.com/radinals/dmenu.git"
    "https://github.com/radinals/st.git"
    "https://github.com/fulhax/ncpamixer"
    "https://github.com/himdel/hsetroot.git"
    "https://github.com/neovim/neovim.git")

BuildDeps=("libgdk-pixbuf-xlib-2.0-0"
    "libxinerama-dev"
    "libimlib2-dev"
    "libx11-dev"
    "libxinerama-dev"
    "pkg-config"
    #"pulseaudio"
    "libncurses-dev"
    "libpulse-dev"
    "libxft-dev"
    "ninja-build"
    "gettext"
    "libtool"
    "libtool-bin"
    "autoconf"
    "automake"
    "cmake"
    "g++"
    "unzip"
    "curl"
    "doxygen")

apt-get -y install "${BuildDeps[@]}" || error "Installing dependencies failed"

for r in "${GitRepoList[@]}"; do
    GitMakeInstall "$r" || error "Failed Installing $r..."
done
